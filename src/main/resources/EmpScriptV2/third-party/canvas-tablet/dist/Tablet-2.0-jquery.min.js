/*
* Tablet
* Tablet是一个基于canvas的在线画板，内置精简版jQuery，无其他依赖，传统网站或vue、react、angular等单页面应用皆可使用！兼容各种移动设备！
* github: https://github.com/941477276/Tablet
*/
(function(p){if("function"===typeof define&&define.amd)define(p);else if("object"===typeof module&&module.exports)module.exports=p(require());else{window.Tablet=p();try{"function"===typeof define&&define(function(q){return p(q())})}catch(q){console.log(q)}}})(function(){function p(a,b,c,f){this.ctx=a;this.ctxBack=b;this.lineConfig=c||{};this.bgConfig=f||{};this.points=[]}function q(a){this.tablet=a.tablet;this.type=a.type;this.linesIndex="undefined"===typeof a.linesIndex?-1:a.linesIndex;this.lines=
[].concat(a.lines);this.lineConfig=a.lineConfig?$.extend({},a.lineConfig):null;this.bgConfig=a.bgConfig?$.extend({},a.bgConfig):null}function l(a,b){this._init(a,b);this._ctxInit()}p.prototype.draw=function(a,b,c,f){a="undefined"===typeof a?1:parseFloat(a);b="undefined"===typeof b?1:parseFloat(b);a=0<a?a:1;b=0<b?b:1;f=this.lineConfig;var e=("undefined"===typeof c?0:c)?this.ctxBack:this.ctx;e.beginPath();for(var d in f)e[d]=f[d];e.lineWidth=f.lineWidth*Math.min(a,b);1==this.points.length?(d=this.points[0],
c=d.x*a,d=d.y*b,e.moveTo(c,d),e.lineTo(c,d),e.stroke()):this.points.forEach(function(g,k){e[0<k?"lineTo":"moveTo"](g.x*a,g.y*b);0<k&&e.stroke()})};p.prototype.addPoint=function(a,b){this.points.push({x:a,y:b})};q.prototype.exec=function(){var a=this,b=this.tablet,c=this.tablet.ctxBack,f=function(d){console.log("\u753b\u7ebf");d="undefined"==typeof d?!1:!!d;a.lines.forEach(function(g){g&&g.draw(b.widthZoomRate,b.heightZoomRate,d,a.tablet.devicePixelRatio)})},e=function(d){"color"==d.bgType?b.setBackgroundColor(d.bgColor,
d.x,d.y,d.width,d.height,!1):"img"==d.bgType&&b.setBackgroundImage(d.bgImg,d.x,d.y,d.width,d.height,null,null,!1)};switch(this.type){case "drawLine":c.clearRect(0,0,b.width,b.height);f(!0);e(a.bgConfig);break;case "bgColor":case "bgImg":c.clearRect(0,0,b.width,b.height),f(!0),e(a.bgConfig)}};l._conut=0;l.prototype._init=function(a,b){a=$(a);if(0==a.length)throw"\u7b2c\u4e00\u4e2a\u53c2\u6570\u5fc5\u987b\u662f\u5305\u88f9\u753b\u5e03\u7684\u9009\u62e9\u5668\u6216dom\u5143\u7d20\uff01";a=a.eq(0);this.config=
{response:!0,width:0,height:0,extraClass:"",defaultColor:"#000",defaultBackgroundColor:"transparent",defaultBgType:"color",defaultBgImg:null,defaultHeight:400,autoResize:!0,imgType:"png",onInit:function(){},onBeforeClear:function(){},onClear:function(){},onEvent:function(c){}};b&&"[object Object]"==={}.toString.call(b)&&$.extend(!0,this.config,b);this.container=a;this.id="Tablet_LYN_"+l._conut++;this.devicePixelRatio=window.devicePixelRatio||1;this.isMobile=/phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone/i.test(navigator.userAgent);
this.lineConfig={strokeStyle:this.config.defaultColor,lineWidth:8,lineWidthZoomRate:1,lineCap:"round",lineJoin:"round",shadowBlur:1,shadowColor:this.config.defaultColor};this.bgConfig={bgColor:this.config.defaultBackgroundColor,bgImg:this.config.bgImg,bgType:this.config.bgType,x:0,y:0,width:-1,height:-1};this.container.append($(this.buildTablet()));this.$tablet=$("#"+this.id);this.$canvas=this.$tablet.find("canvas").eq(0);this.canvas=this.$canvas[0];this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0});
this.$canvasBack=this.$tablet.find(".backup-canvas");this.$canvasBack.hide();this.canvasBack=this.$canvasBack[0];this.ctxBack=this.canvasBack.getContext("2d",{willReadFrequently:!0});this.point={x:0,y:0};this.lines=[];this.operationRecords=[];this.degree=0;this.version="2.0.1";this.width="function"===typeof this.config.width?this.config.width():this.config.width;this.height="function"===typeof this.config.height?this.config.height():this.config.height;this.setCanvasWH(this.width,this.height);this.widthOrigin=
this.width;this.heightOrigin=this.height;this.heightZoomRate=this.widthZoomRate=1;this.config.autoResize&&(this._removeResizeEventFn=this._bindResizeEvent());b=$(window).width();this.isMobile&&(768<=b?this.lineConfig.lineWidth=8:768>b&&414<=b?this.lineConfig.lineWidth=6:414>b&&375<=b?this.lineConfig.lineWidth=4:375>b&&320<=b&&(this.lineConfig.lineWidth=2));this.config.onInit&&"function"===typeof this.config.onInit&&this.config.onInit.call(this)};l.prototype._ctxInit=function(){var a=this;this.pressed=
!1;var b=function(g){return function(k){k.preventDefault();1===g&&(a.pressed=!0);if(1===g||a.pressed){k=a.isMobile?k.touches[0]:k;var h=a.$canvas.offset(),m=$(document.documentElement).scrollTop(),t=$(document.documentElement).scrollLeft();a.point.x=k.clientX-(h.left+.5-t);a.point.y=k.clientY-(h.top+.5-m);switch(g){case 1:a.ctx.beginPath(),a.ctx.moveTo(a.point.x,a.point.y),a.lines.push(new p(a.ctx,a.ctxBack,$.extend({},a.lineConfig),$.extend({},a.bgConfig)));case 2:a.ctx.lineWidth=a.lineConfig.lineWidth*
a.lineConfig.lineWidthZoomRate,a.ctx.lineTo(a.point.x,a.point.y),a.ctx.stroke(),a.lines[a.lines.length-1].addPoint(a.point.x/a.widthZoomRate,a.point.y/a.heightZoomRate)}}}},c=a.lineConfig,f;for(f in c)a.ctx[f]=c[f],a.ctxBack[f]=c[f];a.isMobile||(a.ctx.shadowBlur=c.shadowBlur,a.ctx.shadowColor=c.shadowColor,a.ctxBack.shadowBlur=c.shadowBlur,a.ctxBack.shadowColor=c.shadowColor);c=b(1);b=b(2);var e=function(){a.pressed=!1;0<a.lines.length&&a.lines[a.lines.length-1]&&a.lines[a.lines.length-1].draw(0,
0,!0,a.devicePixelRatio)},d=function(){a.pressed=!1;0<a.lines.length&&(a.operationRecords.push(new q({type:"drawLine",tablet:a,lines:a.lines,bgConfig:a.bgConfig,linesIndex:a.lines.length-1})),a.config.onEvent({type:"drawLine",target:a}))};(function(g){"color"==g.bgType?a.setBackgroundColor(g.bgColor,-1,-1,-1,-1,!1):"img"==g.bgType&&a.setBackgroundImage(g.bgImg,-1,-1,-1,-1,null,null,!1)})({bgType:this.config.defaultBgType,bgColor:this.config.defaultBackgroundColor,bgImg:this.config.defaultBgImg});
this.isMobile?(this.$canvas.on("touchstart",c),this.$canvas.on("touchmove",b)):(this.$canvas.on("mousedown",c),this.$canvas.on("mousemove",b));["touchend","mouseleave","mouseup"].forEach(function(g,k){a.$canvas.on(g,e)});["touchend","mouseup"].forEach(function(g,k){a.$canvas.on(g,d)})};l.prototype._bindResizeEvent=function(){var a="resize",b=this,c=0,f=this.width;a+=window.onorientationchange?" orientationchange":"";console.log("resize event");var e=function(){var d=(new Date).getTime();if(0==c||
100<d-c){c=d;d=b.$tablet;var g=parseFloat(d.css("border-left-width")),k=parseFloat(d.css("border-right-width"));parseFloat(d.css("border-top-width"));parseFloat(d.css("border-bottom-width"));var h=parseFloat(d.css("padding-left")),m=parseFloat(d.css("padding-right"));parseFloat(d.css("padding-top"));parseFloat(d.css("padding-bottom"));g=d.width()-g-k-h-m;d.height();f==g?console.info("container width not changed!"):(f=g,b.setCanvasWH(),b.refresh())}};$(window).on(a,e);return function(){$(window).off(a,
e)}};l.prototype.refresh=function(a){var b=this;("undefined"==typeof a?0:a)&&this.setCanvasWH();var c=b.width/b.widthOrigin,f=b.height/b.heightOrigin,e=b.bgConfig;a=function(){console.log("\u91cd\u7ed8\u80cc\u666f\uff01");"color"==e.bgType?b.setBackgroundColor(e.bgColor,e.x,e.y,e.width,e.height,!1):"img"==e.bgType&&b.setBackgroundImage(e.bgImg,e.x,e.y,e.width,e.height,null,null,!1)};b.lineConfig.lineWidthZoomRate=Math.min(c,f);b.widthZoomRate=c;b.heightZoomRate=f;console.log("rate",Math.min(c,f));
var d=b.hasCanUseLine();console.log("\u6709\u53ef\u7528\u7ebf\u6761",d);if(!d)return b.canvasReset(),a(),this;b.ctxBack.clearRect(0,0,b.width,b.height);b.lines.forEach(function(g){g&&g.draw(c,f,!0,b.devicePixelRatio)});b.ctx.clearRect(0,0,b.width,b.height);if("color"==e.bgType&&"transparent"==e.bgColor)return b.ctx.drawImage(b.canvasBack,0,0,b.width*devicePixelRatio,b.height*devicePixelRatio,0,0,b.width,b.height),this;a();return this};l.prototype.getRect=function(){var a=this.width,b=this.height;
if(90==this.degree||-90==this.degree)a=this.height,b=this.width;var c=this.$canvas.offset();return{x:c.left,y:c.top,width:a,height:b}};l.prototype.hasCanUseLine=function(){return this.lines.some(function(a){return!!a})};l.prototype.setColor=function(a){this.ctx.beginPath();if(!a)return console.error("color is required!"),this;this.lineConfig.strokeStyle=a;this.ctx.strokeStyle=a;this.ctxBack.strokeStyle=a;this.isMobile||(this.lineConfig.shadowColor=a,this.ctx.shadowColor=a,this.ctxBack.shadowColor=
a);return this};l.prototype.setLineWidth=function(a){a=parseFloat(a);if(isNaN(a))return console.error("number is required a Number!"),this;this.lineConfig.lineWidth=a;this.ctx.beginPath();this.ctxBack.beginPath();this.ctx.lineWidth=a;this.ctxBack.lineWidth=a;return this};l.prototype.setBackgroundColor=function(a,b,c,f,e,d){var g=this.getRect(),k=0<f?f:g.width;g=0<e?e:g.height;var h=this.devicePixelRatio;b=0<b?b:0;c=0<c?c:0;this.bgConfig.bgType="color";this.bgConfig.bgColor=a;this.bgConfig.bgImg=null;
this.bgConfig.x=b;this.bgConfig.y=c;this.bgConfig.width=f;this.bgConfig.height=e;this.ctx.clearRect(b,c,k,g);this.ctx.fillStyle=a;this.ctx.fillRect(b,c,k,g);this.hasCanUseLine()&&(console.log("\u91cd\u65b0\u7ed8\u5236",b,c,k*h,g*h,b,c,k,g),this.ctx.drawImage(this.canvasBack,b,c,k*h,g*h,b,c,k,g));"undefined"==typeof d&&(this.operationRecords.push(new q({type:"bgColor",tablet:this,lines:this.lines,bgConfig:this.bgConfig})),this.config.onEvent({type:"bgColor",target:this}));return this};l.prototype.setBackgroundImage=
function(a,b,c,f,e,d,g,k){if(!a)return console.error("setBackgroundImage\u51fd\u6570\u5fc5\u987b\u4f20\u9012\u4e00\u4e2a\u56fe\u7247url\u5730\u5740\u6216\u56fe\u7247dom\u5bf9\u8c61\uff01"),!1;var h=this,m=this.devicePixelRatio,t=function(){var n=h.getRect();b=0<b?b:0;c=0<c?c:0;var r=0<f?f:n.width;n=0<e?e:n.height;h.bgConfig.bgType="img";h.bgConfig.bgImg=a;h.bgConfig.bgColor="";h.bgConfig.x=b;h.bgConfig.y=c;h.bgConfig.width=f;h.bgConfig.height=e;"function"===typeof d&&d({statusCode:2,status:"ok",img:a});
h.ctx.clearRect(b,c,r,n);h.ctx.drawImage(a,b,c,r,n);h.hasCanUseLine()&&(console.log("\u91cd\u65b0\u7ed8\u5236",b,c,r*m,n*m,b,c,r,n),h.ctx.drawImage(h.canvasBack,b,c,r*m,n*m,b,c,r,n));if(k="undefined"==typeof k?!0:!1)h.operationRecords.push(new q({type:"bgImg",tablet:h,lines:h.lines,bgConfig:h.bgConfig})),h.config.onEvent({type:"bgImg",target:h});console.log("\u56fe\u7247\u7ed8\u5236\u5b8c\u6210")},u=function(){console.error("\u56fe\u7247\u52a0\u8f7d\u5931\u8d25,\u4e0d\u80fd\u8fdb\u884c\u7ed8\u5236");
"function"===typeof g&&g()};if("string"==typeof a){"function"===typeof d&&d({statusCode:1,status:"loading"});var v=a;a=new Image;a.onload=t;a.onerror=u;a.src=v}else a.complete?t():(a.onload=t,a.onerror=u)};l.prototype.setCanvasWH=function(a,b){if(a&&b)this.width=a,this.height=b;else{a=this.$tablet;b=parseFloat(a.css("border-left-width"));var c=parseFloat(a.css("border-right-width")),f=parseFloat(a.css("border-top-width")),e=parseFloat(a.css("border-bottom-width")),d=parseFloat(a.css("padding-left")),
g=parseFloat(a.css("padding-right")),k=parseFloat(a.css("padding-top")),h=parseFloat(a.css("padding-bottom"));this.width=a.width()-b-c-d-g;this.height=a.height()-f-e-k-h;0>=this.width&&(this.width=this.container.width());0>=this.height&&(this.height=this.container.height(),0>=this.height&&(this.height=this.config.defaultHeight))}this.$canvas.css("display","block");a=this.lineConfig;(b=this.devicePixelRatio=window.devicePixelRatio||1,1<b)?(c=this.width*b,f=this.height*b,this.$canvas.width(this.width),
this.$canvas.height(this.height),this.$canvasBack.width(this.width),this.$canvasBack.height(this.height),this.canvas.width=c,this.canvas.height=f,this.canvasBack.width=c,this.canvasBack.height=f,this.ctx.scale(b,b),this.ctxBack.scale(b,b),this.ctx.clearRect(0,0,c,f),this.ctxBack.clearRect(0,0,c,f)):(this.canvas.width=this.width,this.canvas.height=this.height,this.canvasBack.width=this.width,this.canvasBack.height=this.height,this.ctx.clearRect(0,0,this.width,this.height),this.ctxBack.clearRect(0,
0,this.width,this.height));for(var m in a)this.ctx[m]=a[m],this.ctxBack[m]=a[m];return this};l.prototype.canvasReset=function(){var a=this.lineConfig,b;for(b in a)this.ctx[b]=a[b],this.ctxBack[b]=a[b];this.isMobile||(this.ctx.shadowBlur=a.shadowBlur,this.ctx.shadowColor=a.shadowColor,this.ctxBack.shadowBlur=a.shadowBlur,this.ctxBack.shadowColor=a.shadowColor);return this};l.prototype.revoke=function(){var a=this.operationRecords;if(0==a.length)return this;var b=a.length-1,c=a.splice(b,1);console.log("step",
b,c[0],c[0].linesIndex);-1<c[0].linesIndex&&this.removeLine(c[0].linesIndex);if(0==a.length)return this.ctx.clearRect(0,0,this.width,this.height),this.ctxBack.clearRect(0,0,this.width,this.height),a=this.config.defaultBgType,b=this.config.defaultBackgroundColor,c=this.config.defaultBgImg,"color"==a?this.setBackgroundColor(b,-1,-1,-1,-1,!1):"img"==a&&this.setBackgroundImage(c,-1,-1,-1,-1,null,null,!1),this;a[b-1].exec();return this};l.prototype.clear=function(a){var b=this.width,c=this.height;a="undefined"===
typeof a?!1:!!a;if(!this.config.onBeforeClear||"function"!==typeof this.config.onBeforeClear||!1!==this.config.onBeforeClear.call(this)){if(90==this.degree||-90==this.degree)b=this.height,c=this.width;this.ctx.clearRect(0,0,b,c);this.ctxBack.clearRect(0,0,b,c);a&&(this.operationRecords=[],this.lines=[]);this.config.onClear&&"function"===typeof this.config.onClear&&this.config.onClear.call(this);return this}};l.prototype.removeLine=function(a){var b=this.lines;console.log("indexOrLine",a);if("number"==
typeof a)b.splice(a,1,null),console.log("lines",b);else if("object"==typeof a){for(var c=-1,f=0,e=b.length;f<e;f++)if(b[f]==a){c=f;break}b.splice(c,1,null)}return this};l.prototype.getImageData=function(){return this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data};l.prototype.getImageColors=function(){function a(e){e=e.toString(16);return 1==e.length?"0"+e:e}function b(e,d,g,k){let h=[];h.push(a(e));h.push(a(d));h.push(a(g));h.push(a(k));return h.join("")}let c=this.getImageData(),
f={};for(let e=0;e<c.length/4;e+=4){let d=b(c[e],c[e+1],c[e+2],c[e+3]);f[d]?f[d]++:f[d]=1}return f};l.prototype.getBase64=function(a,b){if(a){var c=a.toLowerCase();"png"===c?a="image/png":"jpg"===c||"jpeg"===c?a="image/jepg":"webp"===c&&(a="image/webp")}else a="image/png";if(b){c=this.width;var f=this.height,e=this.devicePixelRatio;e&&1<e&&(c*=e,f*=e);-90===b&&(b=270);e=b*Math.PI/180;b=b/90%4;var d=document.createElement("canvas"),g=d.getContext("2d");0===b?(d.width=c,d.height=f,g.drawImage(this.canvas,
0,0)):1===b?(d.width=f,d.height=c,g.translate(.5*d.width,.5*d.height),g.rotate(e),g.drawImage(this.canvas,-d.height/2,-d.width/2)):2===b?(d.width=c,d.height=f,g.translate(.5*c,.5*f),g.rotate(e),g.drawImage(this.canvas,-d.width/2,-d.height/2)):3===b&&(d.width=f,d.height=c,g.translate(.5*d.width,.5*d.height),g.rotate(e),g.drawImage(this.canvas,-d.height/2,-d.width/2));a=d.toDataURL(a,1)}else a=this.canvas.toDataURL(a,.7);return a};l.prototype.getBlob=function(a,b){b=this.getBase64(a,b).split(",");a=
b[0].match(/:(.*?);/)[1];b=atob(b[1]);for(var c=b.length,f=new Uint8Array(c);c--;)f[c]=b.charCodeAt(c);return new Blob([f],{type:a})};l.prototype.buildTablet=function(){return'<div class="-tablet '+this.config.extraClass+'" id="'+this.id+'">    <div class="-canvas-wrapper">        <canvas class="tablet-canvas" style="cursor: crosshair;display: none;"></canvas>        <canvas class="backup-canvas"></canvas>    </div></div>'};l.getMax=function(a,b){var c={left:0,right:0,top:0,bottom:0};if("[object Array]"!==
{}.toString.call(a)||"[object Array]"!=={}.toString.call(b))return c;c.left=Math.min.apply(null,a);c.right=Math.max.apply(null,a);c.top=Math.min.apply(null,b);c.bottom=Math.max.apply(null,b);return c};l.prototype.destroy=function(){this.$canvas.css("cursor","default");this.$canvas.off();this.$canvasBack.off();this.container=this.$tablet=this.ctxBack=this.$canvasBack=this.canvasBack=this.ctx=this.$canvas=this.canvas=null;this.lines=[];this.operationRecords=[];"function"===typeof this._removeResizeEventFn&&
(this._removeResizeEventFn(),this._removeResizeEventFn=null)};return l});
